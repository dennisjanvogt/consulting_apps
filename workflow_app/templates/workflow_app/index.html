<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow App</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'workflow_app/css/style.css' %}?v={% now 'U' %}">
</head>
<body>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <a href="/" class="home-btn" title="Zur√ºck zum Workspace Hub">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </a>
                <h1 class="logo">WORKFLOWS</h1>
            </div>
            <div class="header-actions wf-tabs">
                <button class="tab-btn active" data-tab="templates">Templates</button>
                <button class="tab-btn" data-tab="workflows">Workflows</button>
                <button id="newTemplateBtn" class="btn btn-primary">Neues Template</button>
                <button id="agentBtn" class="btn">AI-Assistent</button>
            </div>
        </header>

        <main class="wf-main">
            <section class="tab-view" id="tab-templates">
                <div id="templatesList" class="cards-grid"></div>
            </section>
            <section class="tab-view hidden" id="tab-workflows">
                <div class="toolbar">
                    <button id="reloadWorkflowsBtn" class="btn">Aktualisieren</button>
                </div>
                <div id="workflowsList" class="cards-grid"></div>
                <div id="workflowDetail" class="workflow-detail hidden"></div>
            </section>
        </main>

        <!-- Template Modal -->
        <div class="modal" id="templateModal">
            <div class="modal-content modal-large">
                <div class="modal-header">
                    <h2>Template erstellen</h2>
                    <button class="modal-close" data-modal-close>&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-row">
                        <input type="text" id="tplTitle" class="form-input" placeholder="Titel">
                        <input type="text" id="tplDesc" class="form-input" placeholder="Beschreibung (optional)">
                        <button id="saveTemplateBtn" class="btn btn-primary">Speichern</button>
                    </div>
                    <div class="nodes-builder">
                        <h3>Hauptpunkte & Unterpunkte</h3>
                        <div id="nodesEditor" class="nodes-editor">
                            <!-- Dynamisch gef√ºllt -->
                        </div>
                        <div class="form-row">
                            <input type="text" id="newMainTitle" class="form-input" placeholder="Neuer Hauptpunkt">
                            <input type="number" id="newMainOffset" class="form-input" placeholder="Zwischenfrist (Tage)">
                            <button id="addMainBtn" class="btn">Hinzuf√ºgen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Start Workflow Modal -->
        <div class="modal" id="startModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Workflow starten</h2>
                    <button class="modal-close" data-modal-close>&times;</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Titel</label>
                        <input type="text" id="wfTitle" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>Endfrist (Datum)</label>
                        <input type="date" id="wfDue" class="form-input">
                    </div>
                    <div class="modal-actions">
                        <button class="btn btn-secondary" data-modal-close>Abbrechen</button>
                        <button class="btn btn-primary" id="confirmStartBtn">Starten</button>
                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Agent Modal -->
        <div class="modal" id="agentModal">
            <div class="modal-content modal-xlarge">
                <div class="modal-header">
                    <h2>ü§ñ AI-Assistent: Workflow erstellen</h2>
                    <button class="modal-close" data-modal-close>&times;</button>
                </div>
                <div class="modal-body" style="padding: 1.5rem; overflow-y: auto;">
                    <div class="form-group">
                        <label for="agentPrompt">Beschreibe deinen Workflow (Ziele, Schritte, Fristen)</label>
                        <textarea id="agentPrompt" class="form-input" rows="5" placeholder="Beispiel: Launch einer Marketing-Kampagne in 6 Wochen. Schritte: Konzept, Assets, Landingpage, Tracking, Soft-Launch, Review. Unterpunkte und Zwischenfristen bitte ber√ºcksichtigen."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>AI Modell ausw√§hlen</label>
                        <div class="model-selection-grid" id="modelSelectionGrid">
                            <!-- Model cards will be inserted here by JavaScript -->
                        </div>
                        <input type="hidden" id="agentModelSelect" value="openai/gpt-4-turbo-preview">
                    </div>
                    
                    <div class="ai-warning" id="aiWarning" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                        <span id="aiWarningText">Kein API Key gefunden. Bitte <a href="/openrouter/" target="_blank">OpenRouter API Key konfigurieren</a>.</span>
                    </div>
                    
                    <div class="modal-actions">
                        <button class="btn btn-primary" id="agentGenerateBtn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 2L11 13"></path>
                                <path d="M22 2L15 22L11 13L2 9L22 2Z"></path>
                            </svg>
                            Vorschlag generieren
                        </button>
                    </div>
                    
                    <div id="agentLoading" class="loading hidden">
                        <div class="loading-bar"><div class="bar"></div></div>
                        <span class="muted">Generiere Workflow-Vorschlag‚Ä¶</span>
                    </div>
                    
                    <div id="agentPreview" class="card hidden">
                        <h3>Vorschau</h3>
                        <div class="muted" id="agentCostInfo"></div>
                        <pre id="agentPreviewJson" style="white-space: pre-wrap; overflow-x: auto;"></pre>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" data-modal-close>Abbrechen</button>
                            <button class="btn btn-primary" id="agentCreateBtn">Workflow anlegen</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script>
        // CSRF Token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    </script>
    <script src="{% static 'workflow_app/js/app.js' %}?v={% now 'U' %}"></script>
</body>
</html>
